{% extends "base.html" %}
{% block content %}
<h2>Firewall Configuration</h2>

{% if pending_changes %}
<div class="alert alert-warning">
  ‚ö†Ô∏è You have unsaved changes.
</div>
{% endif %}

<!-- Existing table, modals, and buttons go here -->
  <div class="container">
<nav class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <strong>Firewall UI</strong>
  </div>
</nav>

{% if dirty %}
  <div class="alert alert-warning d-flex justify-content-between align-items-center">
    <span>‚ö†Ô∏è You have unsaved changes</span>
    <form action="/revert" method="POST">
     <button class="btn btn-sm btn-outline-secondary">‚Ü©Ô∏è Revert</button>
    </form>

  </div>
{% endif %}



<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Firewall Rules</h3>
    <form action="/apply" method="POST" class="m-0">
      <button class="btn btn-sm btn-success">üíæ Apply Changes</button>
    </form>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="/add" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addRuleModalLabel">Add Firewall Rule</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-4">
            <label class="form-label">Incoming Interface</label>
            <select name="iface_in" class="form-select">
              {% for ifname, label in labels.items() if label != "Admin" %}
                <option value="{{ ifname }}">{{ label }} ({{ ifname }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Protocol</label>
            <select name="proto" class="form-select">
              <option>tcp</option>
              <option>udp</option>
              <option>icmp</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Source</label>
            <input name="src" class="form-control" placeholder="e.g. 192.168.95.0/24 or any">
          </div>
          <div class="col-md-6">
            <label class="form-label">Destination</label>
            <input name="dst" class="form-control" placeholder="e.g. 192.168.90.0/24 or any">
          </div>
          <div class="col-md-6">
            <label class="form-label">Destination Port (optional)</label>
            <input name="dport" class="form-control" placeholder="80">
          </div>
          <div class="col-md-6">
            <label class="form-label">Action</label>
            <select name="action" class="form-select">
              <option value="ACCEPT">Allow</option>
              <option value="DROP">Block</option>
              <option value="REJECT">Reject</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Apply Rule</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% for iface in ['eth1','eth2'] %}
  <h4 class="mt-4">{{ labels.get(iface, iface) }} ({{ iface }})</h4>
  <table class="table table-bordered table-sm align-middle">
    <thead class="table-light">
      <tr><th>#</th><th>Src Address</th><th>Dst Address</th><th>Proto</th><th>Port</th><th>Action</th><th></th></tr>
    </thead>
    <tbody>
    {% for r in rules if r.iface_in == iface %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ r.src }}</td>
        <td>{{ r.dst }}</td>
        <td>{{ r.proto }}</td>
        <td>{{ r.dport }}</td>
        <td><span class="badge bg-{{ 'success' if r.action=='ACCEPT' else 'danger' }}">{{ r.action }}</span></td>
<td class="text-center">
  <div class="btn-group">
    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      Actions
    </button>
    <ul class="dropdown-menu">
      <li>
        <form action="/move" method="POST">
          <input type="hidden" name="direction" value="up">
          <input type="hidden" name="rule_num" value="{{ loop.index0 }}">
          <button type="submit" class="dropdown-item">‚¨ÜÔ∏è Move Up</button>
        </form>
      </li>
      <li>
        <form action="/move" method="POST">
          <input type="hidden" name="direction" value="down">
          <input type="hidden" name="rule_num" value="{{ loop.index0 }}">
          <button type="submit" class="dropdown-item">‚¨áÔ∏è Move Down</button>
        </form>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <form action="/delete" method="POST" onsubmit="return confirm('Delete this rule?')">
          <input type="hidden" name="rule_num" value="{{ loop.index0 }}">
          <button type="submit" class="dropdown-item text-danger">üóëÔ∏è Delete</button>
        </form>
      </li>
    </ul>
  </div>
</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% endfor %}
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
    ‚ûï Add Rule
  </button>

    <hr>

<table class="table table-sm table-striped">
  <thead><tr><th>Time</th><th>Action</th><th>Proto</th><th>Source</th><th>Destination</th><th>Interfaces</th></tr></thead>
  <tbody>
    {% for e in entries %}
    <tr>
      <td>{{ e.time }}</td>
      <td><span class="badge bg-{{ 'danger' if e.action=='DROP' else 'warning' }}">{{ e.action }}</span></td>
      <td>{{ e.proto }}</td>
      <td>{{ e.src }}</td>
      <td>{{ e.dst }}</td>
      <td>{{ e.iface }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.querySelectorAll('form[action="/delete"]').forEach(form => {
  form.addEventListener('submit', e => {
    if(!confirm('Delete this rule?')) e.preventDefault();
  });
});
</script>

{% endblock %}
