<?xml version='1.0' encoding='utf-8'?>
<project xmlns="http://www.plcopen.org/xml/tc6_0201" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:ns1="http://www.plcopen.org/xml/tc6_0201">
  <fileHeader companyName="Unknown" productName="Unnamed" productVersion="1" creationDateTime="2024-07-23T12:29:55"/>
  <contentHeader name="Unnamed" modificationDateTime="2025-09-29T16:51:53">
    <coordinateInfo>
      <fbd>
        <scaling x="10" y="10"/>
      </fbd>
      <ld>
        <scaling x="10" y="10"/>
      </ld>
      <sfc>
        <scaling x="10" y="10"/>
      </sfc>
    </coordinateInfo>
  </contentHeader>
  <types>
    <dataTypes/>
    <pous>
      <pou name="main1" pouType="program">
        <interface>
          <localVars>
            <variable name="product_flow_setpoint" address="%MW0">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="13107"/>
              </initialValue>
            </variable>
            <variable name="a_setpoint" address="%MW1">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="30801"/>
              </initialValue>
            </variable>
            <variable name="pressure_sp" address="%MW2">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="55295"/>
              </initialValue>
            </variable>
            <variable name="override_sp" address="%MW3">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="31675"/>
              </initialValue>
            </variable>
            <variable name="level_sp" address="%MW4">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="28835"/>
              </initialValue>
            </variable>
            <variable name="f1_valve_pos" address="%IW100">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="f1_flow" address="%IW101">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="f2_valve_pos" address="%IW102">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="f2_flow" address="%IW103">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="purge_valve_pos" address="%IW104">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="purge_flow" address="%IW105">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="product_valve_pos" address="%IW106">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="product_flow" address="%IW107">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="pressure" address="%IW108">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="level" address="%IW109">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="a_in_purge" address="%IW110">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="b_in_purge" address="%IW111">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="c_in_purge" address="%IW112">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="f1_valve_sp" address="%QW100">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="f2_valve_sp" address="%QW101">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="purge_valve_sp" address="%QW102">
              <type>
                <UINT/>
              </type>
            </variable>
            <variable name="product_valve_sp" address="%QW103">
              <type>
                <UINT/>
              </type>
            </variable>
          </localVars>
          <localVars>
            <variable name="product_valve_safe">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
            <variable name="purge_valve_safe">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="65535"/>
              </initialValue>
            </variable>
            <variable name="f1_valve_safe">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
            <variable name="f2_valve_safe">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </localVars>
          <localVars>
            <variable name="hmi_pressure" address="%MW20">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_level" address="%MW21">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_f1_valve_pos" address="%MW22">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_f1_flow" address="%MW23">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_f2_valve_pos" address="%MW24">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_f2_flow" address="%MW25">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_purge_valve" address="%MW26">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_purge_flow" address="%MW27">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_product_valve" address="%MW28">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="hmi_product_flow" address="%MW29">
              <type>
                <INT/>
              </type>
            </variable>
          </localVars>
          <localVars>
            <variable name="test_real">
              <type>
                <REAL/>
              </type>
            </variable>
          </localVars>
          <localVars>
            <variable name="test_int" address="%MW30">
              <type>
                <UINT/>
              </type>
            </variable>
          </localVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[

f1_valve_sp := control(
     current_value := product_flow,
     setpoint := product_flow_setpoint,
     current_pos := f1_valve_pos,
     k := 20.0,
     rmax := 500.0,
     rmin := 0.0);
     
purge_valve_sp := control(
     current_value := pressure,
     setpoint := pressure_sp,
     current_pos := purge_valve_pos,
     k := -20.0,
     rmax := 3200.0,
     rmin := 0.0);
     
f2_valve_sp := control(
     current_value := a_in_purge,
     setpoint := a_setpoint,
     current_pos := f2_valve_pos,
     k := 1.0,
     rmax := 100.0,
     rmin := 0.0);
     
product_flow_setpoint := pressure_override(
     pressure_in := pressure,
     current_sp := product_flow_setpoint,
     override_sp := override_sp);
   
product_valve_sp := control(
     current_value := level,
     setpoint := level_sp,
     current_pos := product_valve_pos,
     k := -10.0,
     rmax := 100.0,
     rmin := 0.0);  
     
f1_valve_pos := LIMIT(0, f1_valve_pos, 65535);
f1_flow := LIMIT(0, f1_flow, 65535);
f2_valve_pos := LIMIT(0, f2_valve_pos, 65535);
f2_flow := LIMIT(0, f2_flow, 65535);
purge_valve_pos := LIMIT(0, purge_valve_pos, 65535);
purge_flow := LIMIT(0, purge_flow, 65535);
product_valve_pos := LIMIT(0, product_valve_pos, 65535);
product_flow := LIMIT(0, product_flow, 65535);
a_in_purge := LIMIT(0, a_in_purge, 65535);
b_in_purge := LIMIT(0, b_in_purge, 65535);
c_in_purge := LIMIT(0, c_in_purge, 65535);
a_setpoint := LIMIT(0, a_setpoint, 65535);
level := LIMIT(0, level, 65535);
level_sp := LIMIT(0, level_sp, 65535);
pressure_sp := LIMIT(0, pressure_sp, 65535);

product_flow_setpoint := 30000;]]></xhtml:p>
          </ST>
        </body>
      </pou>
      <pou name="scale_to_real" pouType="function">
        <interface>
          <returnType>
            <REAL/>
          </returnType>
          <inputVars>
            <variable name="raw_input_value">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </inputVars>
          <outputVars>
            <variable name="scaled_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </outputVars>
          <inputVars>
            <variable name="real_max">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="real_min">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </inputVars>
          <localVars>
            <variable name="raw_max">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="65535"/>
              </initialValue>
            </variable>
            <variable name="raw_min">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
            <variable name="rate">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="1.0"/>
              </initialValue>
            </variable>
            <variable name="offset">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="1.0"/>
              </initialValue>
            </variable>
          </localVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[rate := (real_max - real_min) / UINT_TO_REAL(raw_max - raw_min);
offset := real_min - UINT_TO_REAL(raw_min)*rate;
scaled_real := UINT_TO_REAL(raw_input_value)*rate + offset;
scale_to_real := scaled_real;]]></xhtml:p>
          </ST>
        </body>
      </pou>
      <pou name="scale_to_uint" pouType="function">
        <interface>
          <returnType>
            <UINT/>
          </returnType>
          <inputVars>
            <variable name="real_in">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </inputVars>
          <outputVars>
            <variable name="uint_out">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </outputVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[uint_out := REAL_TO_UINT((real_in / 100.0) * 65535.0);
scale_to_uint := uint_out;]]></xhtml:p>
          </ST>
        </body>
      </pou>
      <pou name="control" pouType="function">
        <interface>
          <returnType>
            <UINT/>
          </returnType>
          <localVars>
            <variable name="current_value_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="valve_pos_limited">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="setpoint_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="pos_update_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="valve_pos_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </localVars>
          <outputVars>
            <variable name="valve_pos">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </outputVars>
          <inputVars>
            <variable name="rmax">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="rmin">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="k">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="current_value">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
            <variable name="setpoint">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
            <variable name="current_pos">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </inputVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[current_value_real := scale_to_real(raw_input_value := current_value, real_max := rmax, real_min := rmin);

setpoint_real := scale_to_real(raw_input_value := setpoint, real_max := rmax, real_min := rmin);

pos_update_real := (setpoint_real - current_value_real) * k;

valve_pos_real := scale_to_real(raw_input_value := current_pos, real_max := 100.0, real_min := 0.0);

valve_pos_limited := LIMIT(0.0, valve_pos_real + pos_update_real, 100.0);


control := scale_to_uint(real_in:= valve_pos_limited);
]]></xhtml:p>
          </ST>
        </body>
      </pou>
      <pou name="pressure_override" pouType="function">
        <interface>
          <returnType>
            <UINT/>
          </returnType>
          <inputVars>
            <variable name="pressure_in">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </inputVars>
          <localVars>
            <variable name="override_sp_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="2900.0"/>
              </initialValue>
            </variable>
            <variable name="sp_update">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </localVars>
          <inputVars>
            <variable name="current_sp">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </inputVars>
          <localVars>
            <variable name="product_sp_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </localVars>
          <outputVars>
            <variable name="product_sp">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </outputVars>
          <inputVars>
            <variable name="override_sp">
              <type>
                <UINT/>
              </type>
              <initialValue>
                <simpleValue value="0"/>
              </initialValue>
            </variable>
          </inputVars>
          <localVars>
            <variable name="curr_sp_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
            <variable name="pressure_real">
              <type>
                <REAL/>
              </type>
              <initialValue>
                <simpleValue value="0.0"/>
              </initialValue>
            </variable>
          </localVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[pressure_real := scale_to_real(raw_input_value := pressure_in, real_max := 3200.0, real_min := 0.0);

sp_update := MAX(0.0, 1.0 * (override_sp_real - pressure_real));

curr_sp_real := scale_to_real(raw_input_value := current_sp, real_max := 500.0, real_min := 0.0);

product_sp_real := curr_sp_real + sp_update;

product_sp := REAL_TO_UINT(65535.0 * (product_sp_real / 500.0));

pressure_override := product_sp;]]></xhtml:p>
          </ST>
        </body>
      </pou>
      <pou name="complex" pouType="functionBlock">
        <interface>
          <localVars>
            <variable name="IN">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="N">
              <type>
                <BYTE/>
              </type>
            </variable>
            <variable name="OUT">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="ERR">
              <type>
                <BYTE/>
              </type>
            </variable>
            <variable name="I">
              <type>
                <INT/>
              </type>
            </variable>
            <variable name="a">
              <type>
                <INT/>
              </type>
            </variable>
          </localVars>
        </interface>
        <body>
          <ST>
            <xhtml:p><![CDATA[IF N > 1 AND N < 12 THEN
    ERR:=0;
    (* IF IN < P[0].X THEN *)
    IF IN < a THEN
      ERR := 2;
      OUT := a;
    (* ELSIF IN > P[N-1].X THEN *)
    ELSIF IN > a THEN
      ERR := 2;
      OUT := a;
    ELSE
      FOR I:=1 TO a-1 DO
        (* IF P[I-1].X >= P[I].X THEN *)
        IF a >= a THEN
          ERR:=1;
          EXIT;
        END_IF;
        (* IF IN <= P[I].X THEN *)
        IF IN <= a THEN
          EXIT;
        END_IF;
      END_FOR;
      IF ERR = 0 THEN
        (* OUT := DINT_TO_INT(P[I].Y - (P[I].X-IN) * (P[I].Y-P[I-1].Y) / (P[I].X-P[I-1].X)); *)
        OUT := (a - (a - IN) * (a - a) / (a - a));
      ELSE
        OUT:=0;
      END_IF;
    END_IF;
  ELSE
    ERR := 4;
  END_IF;]]></xhtml:p>
          </ST>
        </body>
      </pou>
    </pous>
  </types>
  <instances>
    <configurations>
      <configuration name="Config0">
        <resource name="Res0">
          <task name="task0" priority="0" interval="T#20ms">
            <pouInstance name="instance0" typeName="main1"/>
          </task>
        </resource>
      </configuration>
    </configurations>
  </instances>
</project>
